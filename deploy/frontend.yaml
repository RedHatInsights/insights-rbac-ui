# yaml-language-server: $schema=https://raw.githubusercontent.com/RedHatInsights/frontend-components/refs/heads/master/packages/config-utils/src/feo/spec/frontend-crd.schema.json
---
apiVersion: v1
kind: Template
metadata:
  name: rbac-frontend
objects:
  - apiVersion: cloud.redhat.com/v1alpha1
    kind: Frontend
    metadata:
      name: rbac
    spec:
      envName: ${ENV_NAME}
      title: RBAC
      deploymentRepo: https://github.com/RedHatInsights/insights-rbac-ui
      API:
        versions:
          - v1
        specs:
          - url: https://console.redhat.com/api/rbac/v1/openapi.json
            bundleLabels: ["iam"]
      frontend:
        paths:
          - /apps/rbac
      image: ${IMAGE}:${IMAGE_TAG}
      feoConfigEnabled: true
      searchEntries:
        - id: rbac-org-admin
          title: Org Admins
          href: /iam/user-access/users
          description: Manage your organization's administrator users.
          alt_title:
            - org administrator
          permissions:
            - method: loosePermissions
              args:
                - - rbac:principal:read
      serviceTiles:
        - section: iam
          group: iam
          id: users
          href: /iam/user-access/users
          title: Users
          description: Manage your organization's role-based access control (RBAC) to services.
          icon: PlaceholderIcon
          permissions:
            - method: loosePermissions
              args:
                - - rbac:principal:read
        - section: iam
          group: iam
          id: groups
          href: /iam/user-access/groups
          title: Groups
          description: ""
          icon: PlaceholderIcon
          permissions:
            - method: loosePermissions
              args:
                - - rbac:group:read
        - section: iam
          group: iam
          id: workspaces
          href: /iam/user-access/workspaces
          title: Workspaces
          description: ""
          icon: PlaceholderIcon
          permissions:
            - method: featureFlag
              args:
                - platform.rbac.workspaces-list
                - true
            - method: loosePermissions
              args:
                - - inventory:groups:read
      bundleSegments:
        - segmentId: module-rbac-ui
          bundleId: iam
          navItems:
            # New navigation structure with platform.rbac.workspaces-organization-management feature flag
            - id: overview
              title: Overview
              href: /iam/user-access/overview
              permissions:
                - method: featureFlag
                  args:
                    - platform.rbac.workspaces-organization-management
                    - true
                - method: featureFlag
                  args:
                    - platform.rbac.overview
                    - true
                - method: loosePermissions
                  args:
                    - - rbac:*:read
              product: Identity & Access Management
            - id: my-access
              title: My Access
              href: /iam/my-user-access
              permissions:
                - method: featureFlag
                  args:
                    - platform.rbac.workspaces-organization-management
                    - true
            - id: access-management
              title: Access Management
              expandable: true
              permissions:
                - method: featureFlag
                  args:
                    - platform.rbac.workspaces-organization-management
                    - true
                - method: loosePermissions
                  args:
                    - - rbac:principal:read
                    - - rbac:group:read
                    - - rbac:role:read
                    - - inventory:groups:read
              routes:
                - id: users-and-groups
                  title: Users and Groups
                  href: /iam/access-management/users-and-user-groups
                  permissions:
                    - method: loosePermissions
                      args:
                        - - rbac:principal:read
                        - - rbac:group:read
                  product: Identity & Access Management
                - id: roles
                  title: Roles
                  href: /iam/access-management/roles
                  permissions:
                    - method: loosePermissions
                      args:
                        - - rbac:role:read
                  product: Identity & Access Management
                - id: workspaces
                  title: Workspaces
                  href: /iam/access-management/workspaces
                  icon: PlaceholderIcon
                  permissions:
                    - method: featureFlag
                      args:
                        - platform.rbac.workspaces-list
                        - true
                    - method: loosePermissions
                      args:
                        - - 'inventory:groups:read'
                  product: Identity & Access Management
            - id: organization-management
              title: Organization Management
              expandable: true
              permissions:
                - method: featureFlag
                  args:
                    - platform.rbac.workspaces-organization-management
                    - true
                - method: isOrgAdmin
              routes:
                - id: organization-wide-access
                  title: Organization-Wide Access
                  href: /iam/organization-management/organization-wide-access
                  permissions:
                    - method: isOrgAdmin
                  product: Identity & Access Management
                - id: trusted-organizations
                  title: Trusted Organizations
                  href: /iam/organization-management/trusted-organizations
                  permissions:
                    - method: isOrgAdmin
                  product: Identity & Access Management
                - id: authentication-factors
                  title: Authentication Factors
                  href: /iam/organization-management/authentication-factors
                  permissions:
                    - method: isOrgAdmin
                  product: Identity & Access Management
                - id: identity-provider-integration
                  title: Identity Provider Integration
                  href: /iam/organization-management/identity-provider-integration
                  permissions:
                    - method: isOrgAdmin
                  product: Identity & Access Management
            # Legacy navigation structure (when new feature flag is off)
            - id: my-user-access
              title: My User Access
              href: /iam/my-user-access
              permissions:
                - method: featureFlag
                  args:
                    - platform.rbac.workspaces-organization-management
                    - false
            - id: user-access
              title: User Access
              expandable: true
              permissions:
                - method: loosePermissions
                  args:
                    - - rbac:principal:read
                    - - rbac:group:read
                    - - rbac:role:read
                    - - inventory:groups:read
                - method: featureFlag
                  args:
                    - platform.rbac.workspaces-organization-management
                    - false
              routes:
                - id: overview
                  title: Overview
                  href: /iam/user-access/overview
                  permissions:
                    - method: featureFlag
                      args:
                        - platform.rbac.overview
                        - true
                    - method: loosePermissions
                      args:
                        - - rbac:*:read
                  product: Identity & Access Management
                - id: users
                  title: Users
                  href: /iam/user-access/users
                  permissions:
                    - method: loosePermissions
                      args:
                        - - rbac:principal:read
                  icon: PlaceholderIcon
                  product: Identity & Access Management
                - id: roles
                  title: Roles
                  href: /iam/user-access/roles
                  permissions:
                    - method: loosePermissions
                      args:
                        - - rbac:role:read
                  product: Identity & Access Management
                - id: groups
                  title: Groups
                  href: /iam/user-access/groups
                  permissions:
                    - method: loosePermissions
                      args:
                        - - rbac:group:read
                  icon: PlaceholderIcon
                  product: Identity & Access Management
                - id: workspaces
                  title: Workspaces
                  href: /iam/user-access/workspaces
                  icon: PlaceholderIcon
                  permissions:
                    - method: featureFlag
                      args:
                        - platform.rbac.workspaces-list
                        - true
                    - method: loosePermissions
                      args:
                        - - 'inventory:groups:read'
                  product: Identity & Access Management
                - id: audit-log
                  title: Audit Log
                  href: /iam/user-access/audit-log
                  permissions:
                    - method: loosePermissions
                      args:
                        - - rbac:*:read
                  product: Identity & Access Management
                - segmentRef:
                    frontendName: access-requests
                    segmentId: iam-access-requests
          position: 100
      module:
        manifestLocation: /apps/rbac/fed-mods.json
        defaultDocumentTitle: User Access | Identity & Access Management
        config:
          ssoScopes:
            - api.console
            - api.iam.service_accounts
        modules:
          - id: settings-user-access
            module: ./SettingsUserAccess
            routes:
              - pathname: /settings/rbac
          - id: iam-user-access
            module: ./Iam
            routes:
              - pathname: /iam

parameters:
  - name: ENV_NAME
    required: true
  - name: IMAGE_TAG
    required: true
  - name: IMAGE
    value: quay.io/redhat-services-prod/rh-platform-experien-tenant/insights-rbac-ui
